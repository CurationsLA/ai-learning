<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Open-source frameworks, guides, and resources for AI development, collaboration, and creativity">
    <meta name="author" content="VibeHub">
    <title>RAG Fundamentals - VibeHub - Human Ã— AI Creative Agency</title>
    <link rel="stylesheet" href="/assets/style.css">
    <link rel="stylesheet" href="/assets/highlight.css">
</head>
<body>
    <div class="book-container">
        <div class="book-header">
            <div class="book-header-content">
                <h1 class="book-title">VibeHub - Human Ã— AI Creative Agency</h1>
                <div class="book-header-controls">
                    <input type="search" class="search-input" placeholder="Search..." id="search-input">
                    <button class="theme-toggle" id="theme-toggle" title="Toggle theme">
                        <span class="theme-icon">ğŸŒ“</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="book-body">
            <nav class="book-sidebar">
<div class="book-sidebar-content">
<div class="sidebar-section">
<h3 class="sidebar-section-title">ğŸ  Welcome to CURATIONS</h3>
<ul class="sidebar-list">
<li class="sidebar-item ">
  <a href="/readme.html">Start Here</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/about-curations.html">About CURATIONS</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/about-curationsla.html">About CurationsLA</a>
</li>
</ul>
</div>
<div class="sidebar-section">
<h3 class="sidebar-section-title">ğŸŒŸ Core Initiatives</h3>
<ul class="sidebar-list">
<li class="sidebar-item ">
  <a href="/docs/the-curators.html">The Curators (AI Personas)</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/youth-curator-movement.html">Youth Curator Movement</a>
</li>
</ul>
</div>
<div class="sidebar-section">
<h3 class="sidebar-section-title">ğŸ¨ How We Build</h3>
<ul class="sidebar-list">
<li class="sidebar-item ">
  <a href="/docs/design-systems.html">Design Systems</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/technical-architecture.html">Technical Architecture</a>
</li>
</ul>
</div>
<div class="sidebar-section">
<h3 class="sidebar-section-title">ğŸ“š The AI Ã— Human Cookbook</h3>
<ul class="sidebar-list">
<li class="sidebar-item ">
  <a href="/docs/cookbooks/README.html">About the Cookbook</a>
</li>
</ul>
</div>
<div class="sidebar-section">
<h3 class="sidebar-section-title">ğŸŒ± Foundations: AI Development</h3>
<ul class="sidebar-list">
<li class="sidebar-item ">
  <a href="/docs/cookbooks/foundations/01-interoperability-intro.html">Introduction to Interoperability</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/foundations/02-model-garden.html">Model Garden & Foundation Models</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/foundations/03-memory-management.html">Memory Management</a>
</li>
</ul>
</div>
<div class="sidebar-section">
<h3 class="sidebar-section-title">ğŸ” RAG & Knowledge Systems</h3>
<ul class="sidebar-list">
<li class="sidebar-item active">
  <a href="/docs/cookbooks/rag/01-rag-fundamentals.html">RAG Fundamentals</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/rag/02-agentic-rag.html">Agentic RAG</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/rag/03-graph-rag.html">GraphRAG</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/rag/04-grounding.html">Grounding Techniques</a>
</li>
</ul>
</div>
<div class="sidebar-section">
<h3 class="sidebar-section-title">ğŸ¤– Agent Development</h3>
<ul class="sidebar-list">
<li class="sidebar-item ">
  <a href="/docs/cookbooks/agents/01-adk-overview.html">Agent Development Kits (ADK)</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/agents/02-agent-types.html">Agent Types</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/agents/03-agent-models.html">Agent Models & Contracts</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/agents/04-defining-llm-agents.html">Defining LLM Agents</a>
</li>
</ul>
</div>
<div class="sidebar-section">
<h3 class="sidebar-section-title">ğŸ› ï¸ Tools & Integration</h3>
<ul class="sidebar-list">
<li class="sidebar-item ">
  <a href="/docs/cookbooks/tools/01-mcp.html">Model Context Protocol (MCP)</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/tools/02-a2a.html">Agent2Agent Protocol (A2A)</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/tools/03-tool-ecosystems.html">Tool Ecosystems</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/tools/04-agent-engines.html">AI Agent Engines</a>
</li>
</ul>
</div>
<div class="sidebar-section">
<h3 class="sidebar-section-title">ğŸ§  Advanced Prompting</h3>
<ul class="sidebar-list">
<li class="sidebar-item ">
  <a href="/docs/cookbooks/advanced-prompting/README.html">Overview: Advanced Prompting</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/advanced-prompting/context-manipulation.html">Context Manipulation</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/advanced-prompting/emoji-protocol.html">Emoji Protocol</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/advanced-prompting/meta-prompting.html">Meta-Prompting</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/advanced-prompting/quantum-prompting.html">Quantum Prompting</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/advanced-prompting/temporal-debugging.html">Temporal Debugging</a>
</li>
</ul>
</div>
<div class="sidebar-section">
<h3 class="sidebar-section-title">ğŸ¨ Business: Branding & Growth</h3>
<ul class="sidebar-list">
<li class="sidebar-item ">
  <a href="/docs/cookbooks/business/README.html">Overview: AI-Powered Business</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/business/quantum-brand-engine.html">Quantum Brand Engine</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/business/brand-archaeology.html">Brand Archaeology</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/business/ai-discovery-singularity.html">AI Discovery Singularity (AAO)</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/business/schema-mastery.html">Schema.org Mastery</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/business/creator-engine.html">Creator Singularity Engine</a>
</li>
</ul>
</div>
<div class="sidebar-section">
<h3 class="sidebar-section-title">ğŸš€ Going Legendary</h3>
<ul class="sidebar-list">
<li class="sidebar-item ">
  <a href="/docs/cookbooks/legendary/full-stack-ai.html">Full-Stack AI Applications</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/legendary/production-deployment.html">Production Deployment</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/legendary/scaling.html">Scaling Strategies</a>
</li>
<li class="sidebar-item ">
  <a href="/docs/cookbooks/legendary/the-future.html">The Future We're Building</a>
</li>
</ul>
</div>
<div class="sidebar-section">
<h3 class="sidebar-section-title">ğŸ¤ Get Involved</h3>
<ul class="sidebar-list">
<li class="sidebar-item ">
  <a href="/docs/get-involved.html">How to Contribute, Learn & Collaborate</a>
</li>
</ul>
</div>
</div>
</nav>

            
            <main class="book-main">
                <div class="book-content">
                    <h1 id="rag-fundamentals-retrieval-augmented-generation">ğŸ” RAG Fundamentals: Retrieval-Augmented Generation</h1>
<h2 id="seedling-concept">ğŸŒ± Seedling Concept</h2>
<p><strong>Label</strong>: Grounding AI in Real Data</p>
<p>RAG (Retrieval-Augmented Generation) transforms AI agents from creative storytellers into accurate information providers by grounding their responses in retrieved, factual data.</p>
<h2 id="what-is-rag">What is RAG?</h2>
<h3 id="the-core-idea">The Core Idea</h3>
<p>Instead of relying solely on the model's training data, RAG:</p>
<ol>
<li><strong>Retrieves</strong> relevant information from a knowledge base</li>
<li><strong>Augments</strong> the model's prompt with retrieved context</li>
<li><strong>Generates</strong> a response grounded in actual data</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">User</span><span class="w"> </span><span class="n">Query</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;What&#39;s our return policy?&quot;</span>
<span class="w">                    </span><span class="err">â”‚</span>
<span class="w">                    </span><span class="err">â–¼</span>
<span class="w">           </span><span class="p">[</span><span class="n">Similarity</span><span class="w"> </span><span class="n">Search</span><span class="p">]</span>
<span class="w">                    </span><span class="err">â”‚</span>
<span class="w">                    </span><span class="err">â–¼</span>
<span class="w">         </span><span class="p">[</span><span class="n">Retrieve</span><span class="w"> </span><span class="n">Policy</span><span class="w"> </span><span class="n">Documents</span><span class="p">]</span>
<span class="w">                    </span><span class="err">â”‚</span>
<span class="w">                    </span><span class="err">â–¼</span>
<span class="w">        </span><span class="p">[</span><span class="n">Augment</span><span class="w"> </span><span class="n">Prompt</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">Context</span><span class="p">]</span>
<span class="w">                    </span><span class="err">â”‚</span>
<span class="w">                    </span><span class="err">â–¼</span>
<span class="w">         </span><span class="p">[</span><span class="n">Generate</span><span class="w"> </span><span class="n">Grounded</span><span class="w"> </span><span class="n">Response</span><span class="p">]</span>
</code></pre></div>

<h2 id="why-rag-matters">ğŸ’¡ Why RAG Matters</h2>
<h3 id="without-rag">Without RAG</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Model might hallucinate or provide outdated information</span>
<span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;What&#39;s our return policy?&quot;</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="c1"># Response: &quot;I believe you have 30 days...&quot; (could be wrong)</span>
</code></pre></div>

<h3 id="with-rag">With RAG</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Model grounds response in actual documents</span>
<span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;What&#39;s our return policy?&quot;</span>
<span class="n">relevant_docs</span> <span class="o">=</span> <span class="n">retrieve</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">knowledge_base</span><span class="p">)</span>
<span class="n">context</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Policy documents: </span><span class="si">{</span><span class="n">relevant_docs</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
<span class="c1"># Response: &quot;According to your current policy, customers have 45 days...&quot;</span>
</code></pre></div>

<h2 id="rag-architecture">ğŸŒ¿ RAG Architecture</h2>
<h3 id="three-stage-pipeline">Three-Stage Pipeline</h3>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Stage 1: Indexing                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Document â†’ Chunks â†’ Embeddings â†’ Vector Store  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Stage 2: Retrieval                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Query â†’ Embedding â†’ Similarity Search â†’ Top-K  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Stage 3: Generation                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Context + Query â†’ LLM â†’ Grounded Response      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h2 id="deep-dive-building-a-rag-system">ğŸ”¬ Deep Dive: Building a RAG System</h2>
<h3 id="step-1-generating-embeddings-and-indexing">Step 1: Generating Embeddings and Indexing</h3>
<p><strong>Converting data into vector embeddings</strong> for semantic search:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">class</span> <span class="nc">EmbeddingGenerator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts text into vector embeddings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;text-embedding-004&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_model</span> <span class="o">=</span> <span class="n">load_embedding_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generate_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate embeddings for list of texts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_model</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">embeddings</span>


<span class="k">class</span> <span class="nc">DocumentIndexer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Indexes documents for retrieval</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedder</span> <span class="o">=</span> <span class="n">EmbeddingGenerator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embeddings</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">chunk_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Split document into manageable chunks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">):</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">])</span>
            <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">chunks</span>

    <span class="k">def</span> <span class="nf">index_documents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">documents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process and index documents</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">:</span>
            <span class="c1"># Split into chunks</span>
            <span class="n">doc_chunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_document</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">doc_chunks</span><span class="p">)</span>

            <span class="c1"># Generate embeddings</span>
            <span class="n">chunk_embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedder</span><span class="o">.</span><span class="n">generate_embeddings</span><span class="p">(</span><span class="n">doc_chunks</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embeddings</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chunk_embeddings</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Indexed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="p">)</span><span class="si">}</span><span class="s2"> chunks from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span><span class="si">}</span><span class="s2"> documents&quot;</span><span class="p">)</span>


<span class="c1"># Example usage</span>
<span class="n">indexer</span> <span class="o">=</span> <span class="n">DocumentIndexer</span><span class="p">()</span>
<span class="n">documents</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Our return policy allows customers to return items within 45 days...&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Shipping is free for orders over $50. Standard shipping takes 3-5 days...&quot;</span><span class="p">,</span>
    <span class="s2">&quot;We offer a price match guarantee. If you find a lower price...&quot;</span>
<span class="p">]</span>
<span class="n">indexer</span><span class="o">.</span><span class="n">index_documents</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span>
</code></pre></div>

<h3 id="step-2-storing-and-indexing">Step 2: Storing and Indexing</h3>
<p><strong>Fully managed vector database</strong> for efficient similarity search:</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">VectorStore</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    High-performance vector database for similarity search</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimension</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">768</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">=</span> <span class="n">dimension</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vectors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">add_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vectors</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add vectors with metadata to the store</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vectors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

        <span class="c1"># Build specialized index for fast search</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_index</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">build_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build optimized index for similarity search</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># In production, use libraries like FAISS, Pinecone, or Chroma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_efficient_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vectors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_vector</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find top-k most similar vectors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate similarity scores</span>
        <span class="n">similarities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_similarity</span><span class="p">(</span><span class="n">query_vector</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vectors</span><span class="p">)</span>

        <span class="c1"># Get top-k indices</span>
        <span class="n">top_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">similarities</span><span class="p">)[</span><span class="o">-</span><span class="n">top_k</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Return results with metadata</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">],</span>
                <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">similarities</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">top_indices</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">_compute_similarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">vectors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute cosine similarity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vectors_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span>
        <span class="n">similarities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vectors_array</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vectors_array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">similarities</span>


<span class="c1"># Example usage</span>
<span class="n">vector_store</span> <span class="o">=</span> <span class="n">VectorStore</span><span class="p">()</span>

<span class="c1"># Store indexed chunks</span>
<span class="n">vector_store</span><span class="o">.</span><span class="n">add_vectors</span><span class="p">(</span>
    <span class="n">vectors</span><span class="o">=</span><span class="n">indexer</span><span class="o">.</span><span class="n">embeddings</span><span class="p">,</span>
    <span class="n">metadata</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">chunk</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;policy_docs&quot;</span><span class="p">}</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">indexer</span><span class="o">.</span><span class="n">chunks</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="step-3-retrieval-and-reasoning">Step 3: Retrieval and Reasoning</h3>
<p><strong>Query processing and context retrieval</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">RAGSystem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete RAG implementation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector_store</span><span class="p">:</span> <span class="n">VectorStore</span><span class="p">,</span> <span class="n">llm_model</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vector_store</span> <span class="o">=</span> <span class="n">vector_store</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">llm_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedder</span> <span class="o">=</span> <span class="n">EmbeddingGenerator</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve relevant documents for query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert query to embedding</span>
        <span class="n">query_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedder</span><span class="o">.</span><span class="n">generate_embeddings</span><span class="p">([</span><span class="n">query</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Search vector store</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_store</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query_embedding</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="n">top_k</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate response using retrieved context</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Format context</span>
        <span class="n">context_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="sa">f</span><span class="s2">&quot;[Source </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="c1"># Build prompt</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Answer the following question using ONLY the provided context.</span>
<span class="s2">        If the answer cannot be found in the context, say so.</span>

<span class="s2">        Context:</span>
<span class="s2">        </span><span class="si">{</span><span class="n">context_text</span><span class="si">}</span>

<span class="s2">        Question: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span>

<span class="s2">        Answer:</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="c1"># Generate response</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_question</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Complete RAG pipeline</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Retrieve relevant documents</span>
        <span class="n">relevant_docs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">user_question</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Generate grounded response</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">user_question</span><span class="p">,</span> <span class="n">relevant_docs</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="n">answer</span><span class="p">,</span>
            <span class="s2">&quot;sources&quot;</span><span class="p">:</span> <span class="n">relevant_docs</span><span class="p">,</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">user_question</span>
        <span class="p">}</span>


<span class="c1"># Example usage</span>
<span class="n">rag</span> <span class="o">=</span> <span class="n">RAGSystem</span><span class="p">(</span><span class="n">vector_store</span><span class="p">,</span> <span class="n">llm_model</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">rag</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;What is your return policy?&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Answer: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;answer&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sources used:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">source</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">][:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">... (score: </span><span class="si">{</span><span class="n">source</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="quick-win-simple-rag-in-30-lines">âš¡ Quick Win: Simple RAG in 30 Lines</h2>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">SimpleRAG</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Minimal RAG implementation&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">documents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">documents</span> <span class="o">=</span> <span class="n">documents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedder</span> <span class="o">=</span> <span class="n">EmbeddingModel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">LLM</span><span class="p">()</span>

        <span class="c1"># Index documents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc_embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedder</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">answer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># Embed question</span>
        <span class="n">q_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedder</span><span class="o">.</span><span class="n">embed</span><span class="p">([</span><span class="n">question</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Find most similar documents</span>
        <span class="n">similarities</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">q_embedding</span><span class="p">,</span> <span class="n">doc_emb</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">doc_emb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc_embeddings</span>
        <span class="p">]</span>
        <span class="n">top_3_idx</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">similarities</span><span class="p">)),</span> 
                          <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">similarities</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                          <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>

        <span class="c1"># Get relevant context</span>
        <span class="n">context</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">documents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">top_3_idx</span><span class="p">])</span>

        <span class="c1"># Generate answer</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Context: </span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Question: </span><span class="si">{</span><span class="n">question</span><span class="si">}</span><span class="se">\n</span><span class="s2">Answer:&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>


<span class="c1"># Usage</span>
<span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Return policy: 45 days&quot;</span><span class="p">,</span> <span class="s2">&quot;Shipping: Free over $50&quot;</span><span class="p">]</span>
<span class="n">rag</span> <span class="o">=</span> <span class="n">SimpleRAG</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rag</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;What&#39;s the return policy?&quot;</span><span class="p">))</span>
</code></pre></div>

<h2 id="advanced-hybrid-search">ğŸŒ³ Advanced: Hybrid Search</h2>
<h3 id="combining-dense-and-sparse-retrieval">Combining Dense and Sparse Retrieval</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">HybridRAG</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    RAG with both semantic and keyword search</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense_retriever</span> <span class="o">=</span> <span class="n">DenseRetriever</span><span class="p">()</span>  <span class="c1"># Vector embeddings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparse_retriever</span> <span class="o">=</span> <span class="n">SparseRetriever</span><span class="p">()</span>  <span class="c1"># BM25/TF-IDF</span>

    <span class="k">def</span> <span class="nf">hybrid_retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combine dense and sparse retrieval</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get results from both retrievers</span>
        <span class="n">dense_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense_retriever</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="n">top_k</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">sparse_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_retriever</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="n">top_k</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Reciprocal rank fusion</span>
        <span class="n">combined_scores</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dense_results</span><span class="p">):</span>
            <span class="n">doc_id</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="n">combined_scores</span><span class="p">[</span><span class="n">doc_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined_scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">60</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sparse_results</span><span class="p">):</span>
            <span class="n">doc_id</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="n">combined_scores</span><span class="p">[</span><span class="n">doc_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined_scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">60</span><span class="p">)</span>

        <span class="c1"># Return top-k by combined score</span>
        <span class="n">top_docs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">combined_scores</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> 
                         <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                         <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="n">top_k</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span><span class="n">doc_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">doc_id</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">top_docs</span><span class="p">]</span>
</code></pre></div>

<h2 id="key-takeaways">ğŸ¯ Key Takeaways</h2>
<ul>
<li><strong>RAG grounds LLM responses</strong> in factual, retrieved data</li>
<li><strong>Three stages</strong>: Indexing, Retrieval, Generation</li>
<li><strong>Vector embeddings</strong> enable semantic similarity search</li>
<li><strong>Chunking strategy</strong> affects retrieval quality</li>
<li><strong>Context window</strong> limits how much you can retrieve</li>
</ul>
<h2 id="common-pitfalls">Common Pitfalls</h2>
<h3 id="1-chunks-too-large">1. Chunks Too Large</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># âŒ Bad: Loses granularity</span>
<span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">5000</span>

<span class="c1"># âœ… Good: Balanced granularity</span>
<span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">overlap</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># Preserve context at boundaries</span>
</code></pre></div>

<h3 id="2-ignoring-metadata">2. Ignoring Metadata</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># âœ… Store useful metadata</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">chunk</span><span class="p">,</span>
    <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;docs/policy.pdf&quot;</span><span class="p">,</span>
    <span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-01-15&quot;</span><span class="p">,</span>
    <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;policy&quot;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="3-no-relevance-threshold">3. No Relevance Threshold</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># âœ… Filter low-quality matches</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">vector_store</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">filtered</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">]</span>
</code></pre></div>

<h2 id="next-steps">Next Steps</h2>
<p>Continue to <a href="./02-agentic-rag.md">Agentic RAG</a> to learn how to make your RAG system more intelligent and autonomous.</p>
<hr />
<p>ğŸ’¡ <strong>Pro Tip</strong>: Start with simple RAG, then optimize based on your specific retrieval quality needs.</p>
                </div>
                
                <footer class="book-footer">
                    <div class="book-footer-content">
                        <p>Built with BookGen - A modern GitBook alternative</p>
                        <p>Generated on 2025-11-15 19:18:13</p>
                    </div>
                </footer>
            </main>
            
            
        </div>
    </div>
    
    <script src="/assets/script.js"></script>
</body>
</html>